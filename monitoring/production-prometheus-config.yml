# Prometheus Configuration for Eagle OVault PRODUCTION
# Monitoring LIVE contracts on Ethereum Mainnet
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'eagle-ovault'
    environment: 'production'
    deployment: 'mainnet'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'alertmanager:9093'

# Load alert rules
rule_files:
  - 'production-alert-rules.yml'

# Scrape configurations for production
scrape_configs:
  # Production Ethereum Hub Metrics
  - job_name: 'eagle-ovault-ethereum-production'
    static_configs:
      - targets: ['ethereum-exporter:9090']
        labels:
          chain: 'ethereum'
          role: 'hub'
          network: 'mainnet'
          deployment_status: 'live'
    metrics_path: '/metrics'
    scrape_interval: 15s
    
    # Relabel to add contract addresses
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'eagle_ovault_.*'
        target_label: 'eagle_registry'
        replacement: '0x47c81c9a70CA7518d3b911bC8C8b11000e92F59e'
      - source_labels: [__name__]
        regex: 'eagle_ovault_.*'
        target_label: 'eagle_ovault'
        replacement: '0x47b3ef629D9cB8DFcF8A6c61058338f4e99d7953'
      - source_labels: [__name__]
        regex: 'eagle_ovault_.*'
        target_label: 'eagle_share_oft'
        replacement: '0x474eD38C256A7FA0f3B8c48496CE1102ab0eA91E'
      - source_labels: [__name__]
        regex: 'eagle_ovault_.*'
        target_label: 'eagle_vault_wrapper'
        replacement: '0x47dAc5063c526dBc6f157093dd1D62d9DE8891c5'
      - source_labels: [__name__]
        regex: 'eagle_ovault_.*'
        target_label: 'charm_strategy'
        replacement: '0x47B2659747d6A7E00c8251c3C3f7e92625a8cf6f'

  # Production Contract Monitoring (via custom exporter)
  - job_name: 'production-contracts'
    scrape_interval: 30s
    static_configs:
      - targets: ['contract-monitor:9100']
        labels:
          environment: 'production'
    
    # Contract-specific metrics
    honor_labels: true
    params:
      contracts:
        - '0x47c81c9a70CA7518d3b911bC8C8b11000e92F59e'  # EagleRegistry
        - '0x47b3ef629D9cB8DFcF8A6c61058338f4e99d7953'  # EagleOVault
        - '0x474eD38C256A7FA0f3B8c48496CE1102ab0eA91E'  # EagleShareOFT
        - '0x47dAc5063c526dBc6f157093dd1D62d9DE8891c5'  # EagleVaultWrapper
        - '0x47B2659747d6A7E00c8251c3C3f7e92625a8cf6f'  # CharmStrategyUSD1
        - '0xe5a1d534eb7f00397361F645f0F39e5D16cc1De3'  # Multisig

  # Ethereum RPC Health Check
  - job_name: 'ethereum-rpc-production'
    metrics_path: /probe
    params:
      module: [http_post_2xx]
    static_configs:
      - targets:
          - https://eth-mainnet.g.alchemy.com/v2/omeyMm6mGtblMX7rCT-QTGQvTLFD4J9F
          - https://eth.llamarpc.com
          - https://rpc.ankr.com/eth
        labels:
          type: 'rpc'
          network: 'mainnet'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # Etherscan API Monitor
  - job_name: 'etherscan-api'
    scrape_interval: 60s
    static_configs:
      - targets: ['etherscan-monitor:9101']
        labels:
          service: 'etherscan'
    params:
      addresses:
        - '0x47b3ef629D9cB8DFcF8A6c61058338f4e99d7953'  # Monitor vault

  # Gas Price Oracle
  - job_name: 'gas-oracle-production'
    static_configs:
      - targets: ['gas-oracle:9098']
        labels:
          service: 'gas-oracle'
          network: 'mainnet'
    metrics_path: '/metrics'
    scrape_interval: 60s

  # Multisig Monitor
  - job_name: 'multisig-monitor'
    scrape_interval: 120s
    static_configs:
      - targets: ['multisig-monitor:9102']
        labels:
          multisig: '0xe5a1d534eb7f00397361F645f0F39e5D16cc1De3'
          type: 'gnosis-safe'

  # Node Exporter (System Metrics)
  - job_name: 'node-exporter-production'
    static_configs:
      - targets: ['node-exporter:9100']
    scrape_interval: 30s

  # Blackbox Exporter (Endpoint Health Checks)
  - job_name: 'blackbox-http-production'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - https://eagle-ovault.com
          - https://api.eagle-ovault.com/health
          - https://etherscan.io/address/0x47b3ef629D9cB8DFcF8A6c61058338f4e99d7953
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # Production Event Monitoring
  - job_name: 'contract-events-production'
    static_configs:
      - targets: ['event-indexer:9097']
        labels:
          service: 'event-indexer'
          network: 'mainnet'
    metrics_path: '/metrics'
    scrape_interval: 15s
    params:
      contracts:
        - '0x47b3ef629D9cB8DFcF8A6c61058338f4e99d7953'  # Vault events

# Remote write for long-term storage
remote_write:
  - url: "http://mimir:9009/api/v1/push"
    queue_config:
      capacity: 10000
      max_shards: 10
      min_shards: 1
      max_samples_per_send: 5000
      batch_send_deadline: 5s
    metadata_config:
      send: true
      send_interval: 1m
    write_relabel_configs:
      - source_labels: [__name__]
        regex: 'eagle_ovault_.*'
        action: keep

# Storage configuration for production
storage:
  tsdb:
    retention:
      time: 90d  # Longer retention for production
      size: 100GB
    wal_compression: true

